{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useCallback, useEffect, useState } from \"react\";\nexport function useChat(characterId, personaId) {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [input, setInput] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [favor, setFavor] = useState(0);\n\n  // 메시지 불러오기\n  useEffect(() => {\n    if (!characterId || !personaId) return;\n    fetch(`/api/chat?personaId=${personaId}&characterId=${characterId}`).then(res => res.json()).then(data => {\n      if (data.ok) {\n        setMessages(data.messages.map(msg => ({\n          sender: msg.sender,\n          text: msg.message,\n          avatar: msg.sender === \"ai\" ? `/avatars/${characterId}.jpg` : undefined\n        })));\n        if (typeof data.favor === \"number\") setFavor(data.favor);\n      }\n    });\n  }, [characterId, personaId]);\n  const sendMessage = useCallback(async msg => {\n    if (!msg.trim()) return;\n    setLoading(true);\n    setMessages(prev => [...prev, {\n      sender: \"user\",\n      text: msg\n    }]);\n    const userMsg = msg;\n    setInput(\"\");\n    try {\n      const history = messages.slice(-9).concat([{\n        sender: \"user\",\n        text: msg\n      }]);\n      const requestBody = {\n        personaId,\n        characterId,\n        message: userMsg,\n        sender: \"user\",\n        history: history.map(m => ({\n          ...m,\n          message: m.text\n        }))\n      };\n      console.log('Sending request:', requestBody);\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(requestBody)\n      });\n      const data = await response.json();\n      console.log('Received response:', data);\n      if (data.ok) {\n        if (data.aiText) {\n          setMessages(prev => [...prev, {\n            sender: \"ai\",\n            text: data.aiText,\n            avatar: `/avatars/${characterId}.jpg`\n          }]);\n        }\n        if (typeof data.favorDelta === \"number\" && !isNaN(data.favorDelta) && data.favorDelta !== 0) {\n          setFavor(prev => prev + data.favorDelta);\n          setMessages(prev => [...prev, {\n            sender: \"system\",\n            text: data.favorDelta > 0 ? `호감도 ${data.favorDelta} 증가!` : `호감도 ${-data.favorDelta} 하락!`\n          }]);\n        }\n      } else {\n        console.error(\"Failed to send message:\", data.error);\n      }\n    } catch (error) {\n      console.error(\"Error sending message:\", error);\n    } finally {\n      setLoading(false);\n    }\n  }, [input, characterId, personaId, messages]);\n  return {\n    messages,\n    input,\n    setInput,\n    sendMessage,\n    setMessages,\n    loading,\n    favor\n  };\n}\n_s(useChat, \"oR8J9H1zY5tG5MXtU5L9LieMQiY=\");","map":{"version":3,"names":["useCallback","useEffect","useState","useChat","characterId","personaId","_s","messages","setMessages","input","setInput","loading","setLoading","favor","setFavor","fetch","then","res","json","data","ok","map","msg","sender","text","message","avatar","undefined","sendMessage","trim","prev","userMsg","history","slice","concat","requestBody","m","console","log","response","method","headers","body","JSON","stringify","aiText","favorDelta","isNaN","error"],"sources":["/Users/seungsoohan/LovleChat/frontend/src/hooks/useChat.ts"],"sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\n\nexport interface Msg {\n  sender: \"user\" | \"ai\" | \"system\";\n  text: string;\n  avatar?: string;\n}\n\nexport function useChat(characterId: string, personaId: string) {\n  const [messages, setMessages] = useState<Msg[]>([]);\n  const [input, setInput] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [favor, setFavor] = useState(0);\n\n  // 메시지 불러오기\n  useEffect(() => {\n    if (!characterId || !personaId) return;\n    fetch(`/api/chat?personaId=${personaId}&characterId=${characterId}`)\n      .then(res => res.json())\n      .then(data => {\n        if (data.ok) {\n          setMessages(\n            data.messages.map((msg: any) => ({\n              sender: msg.sender,\n              text: msg.message,\n              avatar: msg.sender === \"ai\" ? `/avatars/${characterId}.jpg` : undefined,\n            }))\n          );\n          if (typeof data.favor === \"number\") setFavor(data.favor);\n        }\n      });\n  }, [characterId, personaId]);\n\n  const sendMessage = useCallback(async (msg: string) => {\n    if (!msg.trim()) return;\n\n    setLoading(true);\n    setMessages((prev) => [...prev, { sender: \"user\", text: msg }]);\n    const userMsg = msg;\n    setInput(\"\");\n\n    try {\n      const history = messages.slice(-9).concat([{ sender: \"user\", text: msg }]);\n      const requestBody = {\n        personaId,\n        characterId,\n        message: userMsg,\n        sender: \"user\",\n        history: history.map(m => ({ ...m, message: m.text }))\n      };\n      console.log('Sending request:', requestBody);\n      \n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(requestBody),\n    });\n      const data = await response.json();\n      console.log('Received response:', data);\n\n      if (data.ok) {\n        if (data.aiText) {\n          setMessages((prev) => [\n            ...prev,\n            {\n              sender: \"ai\",\n              text: data.aiText,\n              avatar: `/avatars/${characterId}.jpg`,\n            },\n          ]);\n        }\n        if (typeof data.favorDelta === \"number\" && !isNaN(data.favorDelta) && data.favorDelta !== 0) {\n          setFavor((prev) => prev + data.favorDelta);\n          setMessages((prev) => [\n            ...prev,\n            {\n              sender: \"system\",\n              text: data.favorDelta > 0 ? `호감도 ${data.favorDelta} 증가!` : `호감도 ${-data.favorDelta} 하락!`,\n            },\n          ]);\n        }\n      } else {\n        console.error(\"Failed to send message:\", data.error);\n      }\n    } catch (error) {\n      console.error(\"Error sending message:\", error);\n    } finally {\n      setLoading(false);\n    }\n  }, [input, characterId, personaId, messages]);\n\n  return { messages, input, setInput, sendMessage, setMessages, loading, favor };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}